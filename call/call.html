<!DOCTYPE html>
<html>
<body>
<h2>You (Caller)</h2>
<video id="local" autoplay playsinline></video>
<video id="remote" autoplay playsinline></video>

<button id="startBtn">Start Call</button>

<script>
let pc = new RTCPeerConnection({
    iceServers: [{ urls: "stun:stun.l.google.com:19302" }]
});

let localVideo = document.getElementById("local");
let remoteVideo = document.getElementById("remote");

pc.ontrack = e => remoteVideo.srcObject = e.streams[0];

pc.onicecandidate = e => {
    if (e.candidate) {
        // Send ICE candidate to server
        fetch("save_caller_ice.php", {
            method: "POST",
            body: JSON.stringify(e.candidate)
        });
    }
};

document.getElementById("startBtn").onclick = async () => {
    let stream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
    stream.getTracks().forEach(track => pc.addTrack(track, stream));
    localVideo.srcObject = stream;

    let offer = await pc.createOffer();
    await pc.setLocalDescription(offer);

    // send offer to server
    await fetch("save_offer.php", {
        method: "POST",
        body: JSON.stringify(offer)
    });

    // Poll for answer
    pollAnswer();
};

async function pollAnswer() {
    setInterval(async () => {
        let res = await fetch("get_answer.php");
        if (!res.ok) return;
        let answer = await res.json();
        if (answer && !pc.currentRemoteDescription) {
            await pc.setRemoteDescription(answer);
        }
    }, 2000);
}
</script>
</body>
</html>