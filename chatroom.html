<!DOCTYPE html>
<html lang="zh-TW">
<head>


  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>隱密聊天室</title>
  <link href="https://cdn.jsdelivr.net/npm/bootswatch@5.3.8/dist/cyborg/bootstrap.min.css" rel="stylesheet">
  <meta name="description" content="瑋語老師的聊天室，歡迎來一起討論">
<meta property="og:image" content="https://cstudio-go.com/cover.png">
<meta name ="keywords" content="瑋語老師, 部落格, 小提琴, 中提琴 ,鋼琴, 編曲, 軟體工程, 音樂作品">

    
  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
<!--font awesome-->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css">
<style>
.selected-color {
  border: 3px solid #555;  /* thicker border for visibility */
  box-sizing: border-box;   /* make sure border doesn’t increase button size */
  transform: scale(1.2);    /* optional: slightly enlarge selected button */
}
.color-btn {
  width: 30px;  /* slightly bigger for mobile */
  height: 30px;
  border: 2px solid transparent;
  border-radius: 4px;
  cursor: pointer;
}

</style>

</head>
<body>
     
  <h6 style="text-align: center; margin-top: 5vw;">
    管理者：鮪魚 ｜<span style="white-space: nowrap; font-size: smaller;">此名稱登入後才能使用</span>
  </h6>

  <div id="chat" style="max-width: 800px; margin: 0 auto; border: 1px brown solid; padding: 10px;">
    <!-- Admin Login Button -->
     <div style="display: flex; justify-content: space-between;">
    <div style="margin-bottom: 10px;">
      <button onclick="adminLogin()" class="btn btn-warning btn-sm">管理者登入</button>
      <span id="loginStatus" style="margin-left:10px; font-weight:bold;">目前狀態</span>
    </div>
    <i class="fa-solid fa-fire fa-beat-fade" style="margin-top: 6px; margin-right: 10px; color: #e32400"  data-bs-toggle="tooltip" data-bs-placement="top" data-bs-custom-class="custom-tooltip" data-bs-title="燃起來"></i>
    </div>
    <!-- Messages -->
    
    <div class="alert alert-dismissible alert-danger" style="border:1px solid #ccc; padding:0 5px;margin: 0 auto 2px auto; font-weight: 400;">
            <span style="color:black;">當前在線人數：</span><span id="visitorCount" style="color: black;">0</span><br>
            *禁止攻擊與不當言論

    </div>
    <div id="messages" style="border:1px solid #ccc; height:300px; overflow:auto; padding:5px;" class="line"></div>

    <!-- Input area -->
    <div style="display: flex; justify-content: left; gap: 10px; margin-top: 5px;">
      <input type="text" id="name" placeholder="姓名" class="form-control form-control-sm" style="max-width:90px;" />
      <input type="text" id="msg" placeholder="輸入訊息" class="form-control form-control-sm" />
      <div style="display:block;">
      <button type="button" class="color-btn" onclick="setColor('white', this)" style="background:white; width:20px; height:20px; border:none; cursor:pointer; margin-top: 4px;"></button>
  <button type="button" class="color-btn" onclick="setColor('rgb(17, 144, 255)', this)" style="background:rgb(17, 144, 255); width:20px; height:20px; border:none; cursor:pointer;"></button>
        </div>
      <button onclick="sendMsg()" class="btn btn-secondary btn-sm">送出</button>
    </div>
  </div>
  <div style="max-width: 800px; margin: 0 auto;">
  <div class="marquee">
<p style="text-align: center;font-size: smaller; color:#d5d2d2;">＊請以友善與尊重的態度交流，<span style="white-space: nowrap;">共同營造良好討論環境。</span></p>
</div>
</div>
  <a href="https://www.cstudio-go.com/main.html" class="btn btn-secondary" style="display: block; max-width: 100px; text-align: center; margin: 20px auto;">回到網站</a>

  <script>
   


    // 1️⃣ Initialize Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyA84CWdlsekXy9KqmUdxhnIE4QQmywkasI",
      authDomain: "cstudio-chat.firebaseapp.com",
      databaseURL: "https://cstudio-chat-default-rtdb.firebaseio.com",
      projectId: "cstudio-chat",
      storageBucket: "cstudio-chat.firebasestorage.app",
      messagingSenderId: "115718281673",
      appId: "1:115718281673:web:669f895cd611d668507018",
      measurementId: "G-F13GF997HL"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const messagesDiv = document.getElementById("messages");
    const loginStatus = document.getElementById("loginStatus");
    const presenceRef = db.ref("presence/admin");

    // 2️⃣ Auth state & presence
    firebase.auth().onAuthStateChanged(user => {
      if (user) {
        presenceRef.set(true);
        presenceRef.onDisconnect().set(false);
        loginStatus.textContent = "管理者目前在線上";
      }
    });

    db.ref("presence/admin").on("value", snapshot => {
      const online = snapshot.val();
      loginStatus.textContent = online ? "管理者目前在線上" : "管理者目前不在喔";
    });

    // 3️⃣ Admin login
    function adminLogin() {
      const provider = new firebase.auth.GoogleAuthProvider();
      firebase.auth()
        .signInWithPopup(provider)
        .then(result => {
          alert("Logged in as admin: " + result.user.displayName);
          loginStatus.textContent = "Logged in as Admin: " + result.user.displayName;
        })
        .catch(error => {
          alert("Login failed: " + error.message);
          loginStatus.textContent = "Not logged in";
        });
    }
let userColor = 'white'; // default color
function setColor(color, btn) {
  userColor = color;
// Remove selection from all color buttons
  document.querySelectorAll('.color-btn').forEach(b => b.classList.remove('selected-color'));

  // Add selection to the clicked button
  btn.classList.add('selected-color');
}
    // 4️⃣ Send message
    function sendMsg() {
      const msg = document.getElementById("msg").value;
      if (!msg) return;

      const user = firebase.auth().currentUser;
      let name = document.getElementById("name").value || "Anonymous";

      // Prevent impersonation
      const adminNames = ["瑋語老師", "瑋語", "張瑋語", "鮪魚" ,"wei","張老師", "玮语老师", "玮语", "张玮语"];
      if (adminNames.includes(name)) {
        if (user) {
          name = "鮪魚";
        } else {
          alert("只有管理者才能使用這個名字喔!");
          return;
        }
      }
      



      db.ref("messages").push({
        name,
        msg,
        color: userColor,
        timestamp: Date.now(),
        uid: user ? user.uid : null
      });

      document.getElementById("msg").value = "";
    }

    // enter key can send messages
    const msgInput = document.getElementById("msg");

msgInput.addEventListener("keydown", function(event) {
  if (event.key === "Enter") {
    event.preventDefault(); // prevent form submission or new line
    sendMsg();              // call your send message function
  }
});




    // 5️⃣ Display messages
   db.ref("messages").on("child_added", snapshot => {
  const { name, msg, color } = snapshot.val();
  const div = document.createElement("div");
  div.style.margin = "2px 0";
  div.style.color = color || "#000"; // fallback to black
  if (name === "鮪魚") {
    div.style.fontWeight = "bold";
    div.style.color = "#d16d0f"; // override admin color
  }
  div.textContent = `${name}: ${msg}`;
  messagesDiv.appendChild(div);
  messagesDiv.scrollTop = messagesDiv.scrollHeight;
});

    const visitorsRef = db.ref("presence/visitors");
let visitorId = null;

function setVisitorPresence() {
  visitorId = Date.now() + "-" + Math.floor(Math.random() * 1000); // unique ID
  const visitorRef = visitorsRef.child(visitorId);
  visitorRef.set(true);
  visitorRef.onDisconnect().remove(); // remove when user leaves
}

setVisitorPresence();

const visitorCountSpan = document.getElementById("visitorCount");
visitorsRef.on("value", snapshot => {
  const count = snapshot.numChildren();
  visitorCountSpan.textContent = count;
});

  </script>
   <!--Tooltips-->
   <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
const tooltipTriggerList = document.querySelectorAll('[data-bs-toggle="tooltip"]')
const tooltipList = [...tooltipTriggerList].map(tooltipTriggerEl => new bootstrap.Tooltip(tooltipTriggerEl))
</script>

</body>
</html>
